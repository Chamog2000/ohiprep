---
title: 'OHI 2016: Sea Level Rise Pressure layers prep'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohiprep/src/templates/ohi_hdr.html'
pdf_document:
  toc: true
---
  
``` {r setup, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 10, fig.height = 8, fig.path = 'Figs/', message = FALSE, warning = FALSE)

#setting up provenance
# devtools::install_github('oharac/provRmd')
# library(provRmd)
# prov_setup()

library(sp)        # the classes and methods that make up spatial ops in R
library(rgdal)
library(raster)
library(tmap)
library(rasterVis)
library(lattice)
library(ggplot2)
library(ncdf4)
library(RColorBrewer)
library(doParallel)
library(foreach)
library(parallel)
library(maptools)
data(wrld_simpl)


dir_git <- '~/github/ohiprep'

source('~/github/ohiprep/src/R/common.R')

dir_anx       <- file.path(dir_M, 'git-annex/globalprep')
dir_anx_aviso <- file.path(dir_M, 'git-annex/globalprep/_raw_data/AVISO_slr/d2016')

### set up proj4string options: WGS84
p4s_wgs84 <- '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'

### Define spectral color scheme for plotting maps
cols      = rev(colorRampPalette(brewer.pal(9, 'Spectral'))(255)) # rainbow color scheme

# define mollweide projection

mollCRS <- CRS('+proj=moll')

# Read in ocean raster with cells at 1km. Use this as a template for resampling
ocean = raster(file.path(dir_M,'git-annex/globalprep/spatial/ocean.tif'))


```

# Summary

There are two parts to creating this layer:
  
1. Data prep to get raw data into the correct format:  
  * If necessary, read .nc.gz files from [AVISO](http://www.aviso.altimetry.fr/en/data/products/ocean-indicators-products/mean-sea-level.html) 
  * unzip .gz files and then delete .gz  
  * Read in monthly mean sea level anomaly data as rasters  

 2. Creating the pressure layer for OHI Global: 
  * Set all non-coastal cells to NA. We are only using coastal data
  * Aggregate monthly data to get mean annual sea level anomalies  
  * Set all negative values to zero, indicating decreases in mean sea level  
  * Rescale from 0 to 1 using a the 99.99th quantile of the data between 2011 - 2015  
  * Resample data from the native cell resolution (0.25 degrees) to ~ 1km 2
  * Determine average SLR pressure per region.

This process is completed entirely within this script.

# Data

Reference: The altimeter products were produced and distributed by Aviso (http://www.aviso.altimetry.fr/), as part of the Ssalto ground processing segment. [AVISO MSLA heights, monthly means](http://www.aviso.altimetry.fr/en/data/products/sea-surface-height-products/global/msla-mean-climatology.html)

* Downloaded: March 18, 2016
* Description: Monthly mean sea level anomaly (meters above mean sea level)
* Native data resolution: 0.25 degree grid cells
* Time range: January 1993 - December 2015
* Format: NetCDF

# Updates to previous methods

Previously the Sea Level Rise pressure layer was derived from a single global data layer; [Mean Sea Level Trends (mm/yr)](http://www.aviso.altimetry.fr/en/data/products/ocean-indicators-products/mean-sea-level/products-images.html). This aggregate data source meant that we could not produce individual layers per year to look at changes over time.

For OHI 2016, we are using data from the same source but provided at monthly time steps; [monthly gridded Mean Sea Level Anomaly data from 1993 - 2015](http://www.aviso.altimetry.fr/en/data/products/sea-surface-height-products/global/msla-mean-climatology.html#c10358). This sea level anomaly data is computed with respect to a twenty-year mean (1993 - 2012). Thus each monthly dataset is a cumulative rather than an instantaneous anomaly. This lets us calculate mean annual sea level anomalies as our pressure layer rather than having to compare to historical reference points or average across multiple years.

***

# Methods

## Data Prep

### Download files

``` {r download_files_and_unzip, eval=F}

reload <- FALSE

if(reload) {
  ### Get filenames from AVISO FTP URL:
  library(RCurl)
  url <- "ftp://ftp.aviso.altimetry.fr/global/delayed-time/grids/climatology/monthly_mean/"
  userpwd <- "ucsb_afflerbach:sioped54j"
  filenames <- getURL(url,
                      userpwd = userpwd,
                      ftp.use.epsv = FALSE,
                      dirlistonly = TRUE) %>%
    str_split('\n') %>%
    unlist()
  
  filenames <- filenames[!str_detect(filenames, '.png')] %>%
    sort()
  
  
  ### Set up loop to download each file and save to git-annex:
  
  ftp_dir <- 'ftp://ucsb_afflerbach:sioped54j@ftp.aviso.altimetry.fr/global/delayed-time/grids/climatology/monthly_mean'
  for (i in 1:length(filenames)) { # nc_file <- filenames[2]
    print(i)
    nc_file <- filenames[i]
    
    download.file(url      = file.path(ftp_dir, nc_file),
                  destfile = file.path(dir_anx_aviso, 'msla_monthly_mean', nc_file),
                  mode     = 'wb')
  }
  
  zipfiles <- list.files(file.path(dir_anx_aviso, 'msla_monthly_mean'),
                         full.names = TRUE)
  zipfiles <- zipfiles[str_detect(zipfiles, '.gz')]
  for (zipfile in zipfiles) { # zipfile <- zipfiles[1]
    message('Unzipping file: ', zipfile)
    R.utils::gunzip(zipfile, remove = TRUE, skip = TRUE)
  }
}
```


### Clip data to coastal cells

All NetCDF files for each month over the 22 years are rasterized and all non-coastal cells are removed. To do this we use `raster::boundaries()` with the `type = 'inner'` which turns all coastal cells bordering land to 1 and the rest of the cells to 0. This layer is then used as a mask to remove non-coastal cells.


```{r coastal_cells}

#list all netCDF files
nc_files <- list.files(file.path(dir_anx_aviso, 'msla_monthly_mean'),
                       full.names = TRUE,pattern='.nc')

plot(raster(nc_files[276]),col=cols,main = 'Mean Sea Level Anomaly (m) \n December 2015', axes = F)
```

Raw data is disaggregated into smaller cell sizes to create a raster of all coastal cells. The resampling needs to be done first to ensure we get the small islands that would otherwise be ignored at larger cell sizes

```{r clip, eval = F}

# read in OHI eez shapefile and remove non-land polygons
    land <- readOGR(dsn= file.path(dir_anx,'spatial/d2014/data'),layer = 'regions_gcs')%>%
              subset(rgn_typ=='land')

#take one of the raw data files, rotate and disaggregate 
    r <- raster(nc_files[1])%>%
          rotate()%>%
            disaggregate(fact = 8)

#define projection of the raster before reprojecting
    projection(r) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
    
    r_mask <- mask(r,land, progress='text')
    
    r_in <- r%>%
             mask(r_mask, inverse=T, filename = file.path(dir_anx,'prs_slr/v2016/int/land_mask.tif'),progress='text',overwrite=T)%>%
              boundaries(type='inner',asNA=T) ## Using type='inner' we get all coastal cells bordering land. This is what we want to use for this pressure layer
    
    r_in[r_in==0]<-NA
    
    writeRaster(r_in,filename=file.path(dir_anx,'prs_slr/v2016/int/coastal_cells.tif'),overwrite=T)

```

Here is the mask used to remove non-coastal cells. All red cells border land.

```{r plot_coast_cells}

plot(raster(file.path(dir_anx,'prs_slr/v2016/int/coastal_cells.tif')),col=cols,axes=F,main = 'Coastal cells')

```

`months_coast` is a function that uses the mask on each monthly data layer and saves the output.

```{r months_coast_fun, eval = F}

## Function that rotates each monthly file, sets the long/lat projection, and keeps only coastal cells - saved to GitHub
    
months_coast <- function(x){
  
  m_yr <- substr(x,108,115)
    
  #read in month raster
   r <- raster(x)%>%
          rotate()%>%
        disaggregate(fact = 8)
  
  #define projection of the raster before reprojecting
  projection(r) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
  
  r_mask <- mask(r,r_in,progress='text')

  
  writeRaster(r_mask,filename=paste0(dir_git,'/globalprep/prs_slr/v2016/int/msla_monthly_coast/msla_monthly_coast_',m_yr,'.tif'),overwrite=T)

}

#apply the clipping function to all files
mclapply(nc_files,months_coast,mc.cores=10)

```

## Create Layer

### Calculate Annual Means

Annual mean sea level anomalies from 1993 to 2015 are calculated from the monthly data.

``` {r msla_monthly_to_annual, eval = F}

#list all monthly files (these have already been clipped to the coast)
month_files <- list.files(file.path(dir_git,'globalprep/prs_slr/v2016/int/msla_monthly_coast'),full.names=T)

#define our years
all_yrs <- c(1993:2015)

#take advantage of parallel processing
registerDoParallel(10) 

#for each year in all_yrs, stack all 12 monthly files and calculate the mean, save the file.
foreach (j = all_yrs) %dopar% {
  
  msla_yr <- month_files[str_detect(month_files, as.character(j))]
  
  message('Generating annual MSLA raster for ', j)
  
  ### stack all rasters for this year, and calc annual mean, then write as raster
  rast_annual_mean <- stack(msla_yr)%>%
                      calc(mean,na.rm=T)%>%
                      writeRaster(filename = paste0(file.path(dir_git),'/globalprep/prs_slr/v2016/int/msla_annual_mean/rast_msla_annual_',j,'.tif'),overwrite=T)

}

```

### Reference Point

The reference point is calculated across the 5 most recent years, 2011 - 2015.

```{r ref, eval=F}

annual_means <- list.files(file.path(dir_git,'globalprep/prs_slr/v2016/int/msla_annual_mean'),pattern = '*.tif',full.names=T)

#get data across all 5 years 2011 - 2105

vals <- c() #empty vector to collect the data from each raster layer

for(i in 2011:2015){
  
  # take annual raster and grab all values from the raster.
  m <- annual_means[which(substr(annual_means,96,99) == i)]%>%
          raster()%>%
          getValues()
  
  #combine with values from other raster
  vals <- c(vals,m)
  
}

#remove NAs
vals <- vals[!is.na(vals)]

#look at a histogram of the data
hist(vals)

#set negative values to 0 before taking ref point
vals[vals<0]<-0

#look at a histogram again
hist(vals)

#the reference point is the 99.99th quantile
ref <- quantile(vals,prob=0.9999,na.rm=T)

#0.341

```

### Rescale 

Rescale each of the 5 most recent years using the reference point

```{r rescale, eval = F}

recent_yrs <- annual_means[which(substr(annual_means,96,99) %in% c(2011:2015))]

resc_slr <- function(file){

  yr <- substr(file, 96,99)
        raster(file)%>%
          calc(fun=function(x){ifelse(x<0,0,x)})%>% #set all negative values to 0
          calc(fun=function(x){ifelse(x>ref,1,x/ref)})%>%
          projectRaster(crs = mollCRS,over=T)%>%
          resample(ocean,method = 'ngb', filename = paste0(file.path(dir_anx),'/prs_slr/v2016/output/slr_',yr,'.tif'),overwrite=T)

}

mclapply(recent_yrs,resc_slr,mc.cores = 5)

```


## Results

```{r plot}

resc <- list.files(file.path(dir_anx,'prs_slr/v2016/output'),full.names = T)

plot(ocean,col='cornsilk2',axes=F,box=F,main='Sea Level Rise Pressure 2015',legend=F)
plot(raster(resc[5]),col=cols,axes=F,box=F,add=T)
```

