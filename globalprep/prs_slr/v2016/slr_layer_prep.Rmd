---
  title: 'OHI 2016: Sea Level Rise Pressure layers prep'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
  toc: true
  number_sections: true
  theme: cerulean
  highlight: haddock
includes: 
  in_header: '~/github/ohiprep/src/templates/ohi_hdr.html'
pdf_document:
  toc: true
---

# Summary

There are two parts to creating this layer:
  
  1. Data prep to get raw data into the correct format:
  * If necessary, read .nc.gz files from aviso: ftp://ftp.aviso.altimetry.fr/global/delayed-time/grids/climatology/monthly_mean/
  * unzip .gz files and then delete .gz 
* Read monthly mean sea level data as rasters; aggregate to annual means

2. Creating the pressure layers for OHI Global:
* All annual means are clipped to the coast using `raster::boundaries()`
* Each year is 
* Set to zero all negative values, indicating decreases in mean sea level
* Resample raster to ~ 1km2
* Set reference point as the 99.99th quantile of the data from 2011 - 2015 to rescale all values from 0 to 1

This process is completed entirely within this script.

# Data

The raw data are monthly mean sea level anomalies, in m. The anomalies are calculated using a reference period of 1993 - 2012. The anomalies represent a cumulative anomaly rather than an instantaneous anomaly. For example, in the following plot shows the Mean Sea Level Anomaly for May, 2015. This data is equal to the total increase in sea level as of May, 2015 after subtracting out the mean climatology from 1993-2012.

Since these data have already been calculated using a reference point, we only need to create annual mean rasters for each year and then rescale from 0 to 1. In order to rescale each layer, the 99.99th quantile of the entire data distribution from 2011-2015 is used, rather than calculating the 99.99th quantile for each year. This way we have a consistent reference point across time that will be forecasted backwards and used in future OHI assessments when creating this layer.

![A map of the mean sea level height anomaly for May 31, 2014, taken from the AVISO Ssalto/Duacs two_sat_merged data set - available here at ICDC.]()

Reference: The altimeter products were produced and distributed by Aviso (http://www.aviso.altimetry.fr/), as part of the Ssalto ground processing segment. [AVISO MSLA heights, monthly means](http://www.aviso.altimetry.fr/en/data/products/sea-surface-height-products/global/msla-mean-climatology.html)

* Downloaded: March 18, 2016
* Description: Monthly mean sea level anomaly (meters above mean sea level)
* Native data resolution: 0.25 degree grid cells
* Time range: January 1993 - December 2015
* Format: NetCDF

# Methods

## Setup

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

#setting up provenance
# devtools::install_github('oharac/provRmd')
# library(provRmd)
# prov_setup()

library(sp)        # the classes and methods that make up spatial ops in R
library(rgdal)
library(raster)
library(tmap)
library(rasterVis)
library(lattice)
library(ggplot2)
library(ncdf4)
library(RColorBrewer)
library(doParallel)
library(foreach)
library(parallel)
library(maptools)
data(wrld_simpl)


dir_git <- '~/github/ohiprep'

source('~/github/ohiprep/src/R/common.R')

dir_anx <- file.path(dir_M, 'git-annex/globalprep')

dir_anx_aviso <- file.path(dir_M, 'git-annex/globalprep/_raw_data/AVISO_slr/d2016')

### set up proj4string options: WGS84
p4s_wgs84 <- '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'

### Define spectral color scheme for plotting maps
cols      = rev(colorRampPalette(brewer.pal(9, 'Spectral'))(255)) # rainbow color scheme

# define mollweide projection

mollCRS <- CRS('+proj=moll')

# Read in ocean raster with cells at 1km. Use this as a template for resampling

ocean = raster(file.path(dir_M,'git-annex/globalprep/spatial/ocean.tif'))
```


## Data Prep

### Download files

``` {r download_files_and_unzip, eval=F}

reload <- FALSE

if(reload) {
  ### Get filenames from AVISO FTP URL:
  library(RCurl)
  url <- "ftp://ftp.aviso.altimetry.fr/global/delayed-time/grids/climatology/monthly_mean/"
  userpwd <- "ucsb_afflerbach:sioped54j"
  filenames <- getURL(url,
                      userpwd = userpwd,
                      ftp.use.epsv = FALSE,
                      dirlistonly = TRUE) %>%
    str_split('\n') %>%
    unlist()
  
  filenames <- filenames[!str_detect(filenames, '.png')] %>%
    sort()
  
  
  ### Set up loop to download each file and save to git-annex:
  
  ftp_dir <- 'ftp://ucsb_afflerbach:sioped54j@ftp.aviso.altimetry.fr/global/delayed-time/grids/climatology/monthly_mean'
  for (i in 1:length(filenames)) { # nc_file <- filenames[2]
    print(i)
    nc_file <- filenames[i]
    
    download.file(url      = file.path(ftp_dir, nc_file),
                  destfile = file.path(dir_anx_aviso, 'msla_monthly_mean', nc_file),
                  mode     = 'wb')
  }
  
  zipfiles <- list.files(file.path(dir_anx_aviso, 'msla_monthly_mean'),
                         full.names = TRUE)
  zipfiles <- zipfiles[str_detect(zipfiles, '.gz')]
  for (zipfile in zipfiles) { # zipfile <- zipfiles[1]
    message('Unzipping file: ', zipfile)
    R.utils::gunzip(zipfile, remove = TRUE, skip = TRUE)
  }
}
```


### Clip data to coastal cells

All NetCDF files for each month over the 22 years is rasterized and all non-coastal bordering cells are removed. To do this we use `raster::boundaries()` with the `type = 'inner'` which turns all coastal cells bordering land to 1 and the rest of the cells to 0.


```{r clip,eval=F}

#list all netCDF files
nc_files <- list.files(file.path(dir_anx_aviso, 'msla_monthly_mean'),
                       full.names = TRUE,pattern='.nc')

#--------------------------------------------------------------------
## resampling raw data to smaller cell size, then create a raster of all coastal cells. The resampling needs to be done
## first to ensure we get the small islands that would otherwise be ignored at larger cell seizes

# land <- readOGR(dsn= file.path(dir_anx,'spatial/d2014/data'),layer = 'regions_gcs')%>%
#           subset(rgn_typ=='land')

#offshore 3 nm polygon for all regions
three_nm <- readOGR(dsn= file.path(dir_anx,'spatial/d2014/data'),layer = 'regions_offshore3nm_gcs')

    r <- raster(nc_files[1])%>%
            rotate()%>%
            disaggregate(fact = 8)
    
    #define projection of the raster before reprojecting
    projection(r) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
    
    r_3nm_mask <- mask(r,three_nm, progress='text')
    writeRaster(r_3nm_mask,filename = file.path(dir_anx,'prs_slr/v2016/int/rast_3nm_mask.tif'))
    
    # r_in <- r%>%
    #          mask(r_mask, inverse=T, filename = file.path(dir_anx,'prs_slr/v2016/int/land_mask.tif'),progress='text',overwrite=T)%>%
    #           boundaries(type='inner',asNA=T)
    # 
    # r_in[r_in==0]<-NA
    
   # writeRaster(r_in,filename=file.path(dir_anx,'prs_slr/v2016/int/coastal_cells.tif'),overwrite=T)

## Using type='inner' we get all coastal cells bordering land. This is what we want to use for this pressure layer


#--------------------------------------------------------------------

## Function that rotates each monthly file, sets the long/lat projection, and keeps only coastal cells - saved to GitHub
    
    registerDoParallel(6) 
    
months_coast <- function(x){
  
  m_yr <- substr(x,108,115)
    
  #read in month raster
   r <- raster(x)%>%
          rotate()%>%
        disaggregate(fact = 8)
  
  #define projection of the raster before reprojecting
  projection(r) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
  
  r_mask <- mask(r,r_3nm_mask,progress='text')

  
  writeRaster(r_mask,filename=paste0(dir_git,'/globalprep/prs_slr/v2016/int/msla_monthly_coast/msla_monthly_coast_',m_yr,'.tif'),overwrite=T)

}

#apply the clipping function to all files
mclapply(nc_files,months_coast,mc.cores=10)

```


```{r years}

#years of interest

years <- c(2010:2015)

months <- c(1:12)

```


### Read raw data as monthly means and convert to annual means

Raw data in monthly mean sea level anomalies, at .25 degree grid globally, is processed into annual mean sea level anomalies.

``` {r msla_monthly_to_annual}

month_files <- list.files(file.path(dir_git,'globalprep/prs_slr/v2016/int/msla_monthly_coast'),full.names=T)

all_yrs <- c(1993:2015)

registerDoParallel(10) 

foreach (j = all_yrs) %dopar% {
  
  msla_yr <- month_files[str_detect(month_files, as.character(j))]
  
  message('Generating annual MSLA raster for ', j)
  
  ### stack all rasters for this year, and calc annual mean, then write as raster
  rast_annual_mean <- stack(msla_yr)%>%
                      calc(mean,na.rm=T)%>%
                      writeRaster(filename = paste0(file.path(dir_git),'/globalprep/prs_slr/v2016/int/msla_annual_mean/rast_msla_annual_',j,'.tif'),overwrite=T)


  ### stack all rasters for this year, and calc annual standard deviation, then write as raster
  rast_annual_sd <- stack(msla_yr)%>%
                      calc(sd,na.rm=T)%>%
                      writeRaster(filename = paste0(file.path(dir_git),'/globalprep/prs_slr/v2016/int/msla_annual_sd/rast_msla_annual_sd_',j,'.tif'),overwrite=T)

}

```

### Reference Point

The reference point is calculated across the 5 most recent years, 2011 - 2015.

```{r ref}

annual_means <- list.files(file.path(dir_git,'globalprep/prs_slr/v2016/int/msla_annual_mean'),pattern = '*.tif',full.names=T)

#get data across all 5 years
vals <- c()
for(i in 2011:2015){
  
  m <- annual_means[which(substr(annual_means,96,99) == i)]%>%raster()%>%getValues
  
  vals <- c(vals,m)
  
}

vals <- vals[!is.na(vals)]

hist(vals)

#set negative values to 0 before taking ref point
vals[vals<0]<-0

hist(vals)

ref <- quantile(vals,prob=0.9999,na.rm=T)

```

# Rescale 

Rescale each of the 5 most recent years using the reference point

```{r rescale}

recent_yrs <- annual_means[which(substr(annual_means,96,99) %in% c(2011:2015))]

resc_slr <- function(file){

  yr <- substr(file, 96,99)
    raster(file)%>%
      calc(fun=function(x){ifelse(x<0,0,x)})%>% #set all negative values to 0
      calc(fun=function(x){ifelse(x>ref,1,x/ref)})%>%
      projectRaster(crs = mollCRS,over=T)%>%
      resample(ocean,method = 'ngb', filename = paste0(file.path(dir_anx),'/prs_slr/v2016/output/slr_',yr,'.tif'),overwrite=T)

}

mclapply(recent_yrs,resc_slr,mc.cores = 5)

```


## Calculate mean pressure by region by year

Using 1000 m region ID raster to run zonal statistics on the pressures layers, calculate the regional average pressures for the study period, and save as a .csv.

``` {r calc_mean_pressures_by_year}

slr_rgn_mean <- zonal(bc_slr_resc, rast_rgn, fun = 'mean') %>%
  as.data.frame() %>%
  rename(pressure = mean, rgn_id = zone) %>%
  left_join(rgn_poly@data %>% select(rgn_id, rgn_name), by = 'rgn_id')

knitr::kable(slr_rgn_mean)

write_csv(slr_rgn_mean, file.path(dir_goal, 'output/slr/slr_rgn_pressures.csv'))

```

    ``` {r child = 'prov/prov_ftr2.Rmd'}
    ```