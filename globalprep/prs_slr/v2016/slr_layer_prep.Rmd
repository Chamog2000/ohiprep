---
  title: 'OHI 2016: Sea Level Rise Pressure layers prep'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
  toc: true
number_sections: true
theme: cerulean
highlight: haddock
includes: 
  in_header: '~/github/ohiprep/src/templates/ohi_hdr.html'
pdf_document:
  toc: true
---
  
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

#setting up provenance
# devtools::install_github('oharac/provRmd')
# library(provRmd)
# prov_setup()

library(sp)        # the classes and methods that make up spatial ops in R
library(rgdal)
library(raster)
library(rasterVis)
library(lattice)
library(ncdf4)
library(RColorBrewer)
library(doParallel)
library(foreach)
library(parallel)


dir_git <- '~/github/ohiprep'
source('~/github/ohiprep/src/R/common.R')

dir_anx <- file.path(dir_M, 'git-annex/globalprep')

### set up proj4string options: WGS84
p4s_wgs84 <- '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'

### Define spectral color scheme for plotting maps
cols      = rev(colorRampPalette(brewer.pal(9, 'Spectral'))(255)) # rainbow color scheme

# define mollweide projection

mollCRS <- CRS('+proj=moll')

```

# Summary

There are two parts to creating this layer:
  
  1. Data prep to get raw data into the correct format:
  * If necessary, read .nc.gz files from aviso: ftp://ftp.aviso.altimetry.fr/global/delayed-time/grids/climatology/monthly_mean/
  * unzip .gz files and then delete .gz 
* Read monthly mean sea level data as rasters; aggregate to annual means
2. Creating the pressure layers for OHI Global:
  * Determine baseline using five-year average from 1993-1997.
* For each study year (2000 - 2015) calculate difference between study year and baseline
* Set to zero all negative values, indicating decreases in mean sea level
* Resample data from the native cell resolution (0.25 degrees) to ~ 1km
* Set reference point as the 99.99th quantile of the data distribution to rescale all values from 0 to 1
* Use thin plate spline interpolation to fill in NA values
* Clip results to 1 km offshore region, and determine average SLR pressure per region.

This process is completed entirely within this script.

# Data

Reference: The altimeter products were produced and distributed by Aviso (http://www.aviso.altimetry.fr/), as part of the Ssalto ground processing segment. [AVISO MSLA heights, monthly means](http://www.aviso.altimetry.fr/en/data/products/sea-surface-height-products/global/msla-mean-climatology.html)

* Downloaded: March 18, 2016
* Description: Monthly mean sea level anomaly
* Native data resolution: 0.25 degree grid cells
* Time range: January 1993 - August 2015
* Format: NetCDF

# Methods

## Data Prep

### Download files

``` {r download_files_and_unzip}

reload <- FALSE

dir_anx_aviso <- file.path(dir_M, 'git-annex/globalprep/_raw_data/AVISO_slr/d2016')

if(reload) {
  ### Get filenames from AVISO FTP URL:
  library(RCurl)
  url <- "ftp://ftp.aviso.altimetry.fr/global/delayed-time/grids/climatology/monthly_mean/"
  userpwd <- "ucsb_afflerbach:sioped54j"
  filenames <- getURL(url,
                      userpwd = userpwd,
                      ftp.use.epsv = FALSE,
                      dirlistonly = TRUE) %>%
    str_split('\n') %>%
    unlist()
  
  filenames <- filenames[!str_detect(filenames, '.png')] %>%
    sort()
  
  
  ### Set up loop to download each file and save to git-annex:
  
  ftp_dir <- 'ftp://ucsb_afflerbach:sioped54j@ftp.aviso.altimetry.fr/global/delayed-time/grids/climatology/monthly_mean'
  for (i in 1:length(filenames)) { # nc_file <- filenames[2]
    print(i)
    nc_file <- filenames[i]
    
    download.file(url      = file.path(ftp_dir, nc_file),
                  destfile = file.path(dir_anx_aviso, 'msla_monthly_mean', nc_file),
                  mode     = 'wb')
  }
  
  zipfiles <- list.files(file.path(dir_anx_aviso, 'msla_monthly_mean'),
                         full.names = TRUE)
  zipfiles <- zipfiles[str_detect(zipfiles, '.gz')]
  for (zipfile in zipfiles) { # zipfile <- zipfiles[1]
    message('Unzipping file: ', zipfile)
    R.utils::gunzip(zipfile, remove = TRUE, skip = TRUE)
  }
}
```


### Clip data to coastal cells

All NetCDF files for each month over the 22 years is rasterized and all non-coastal bordering cells are removed. To do this we use `raster::boundaries()` with the `type = 'inner'` which turns all coastal cells bordering land to 1 and the rest of the cells to 0.


```{r clip,eval=F}

#list all netCDF files
nc_files <- list.files(file.path(dir_anx_aviso, 'msla_monthly_mean'),
                       full.names = TRUE,pattern='.nc')

#--------------------------------------------------------------------
## Testing boundaries() to get only coastal cells

    r <- raster(nc_files[1])
    
    r_in <- boundaries(r,type='inner',asNA=T)%>%
            rotate(,filename=file.path(dir_git,'globalprep/prs_slr/v2016/int/r_inner_boundaries.tif'),overwrite=T)
    #r_out <- boundaries(r,type='outer',asNA=T,filename=file.path(dir_anx,'prs_slr/v2016/test/r_outer_boundaries.tif'))

## Using type='inner' we get all coastal cells bordering land. This is what we want to use for this pressure layer


#--------------------------------------------------------------------

## Function that rotates each monthly file, sets the long/lat projection, and keeps only coastal cells - saved to GitHub
months_coast <- function(x){
  
  m_yr <- substr(x,108,115)
    
  #read in month raster
   r <- raster(x)%>%rotate()
  
  #define projection of the raster before reprojecting
  projection(r) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
  
  r_mask <- mask(r,r_in,progress='text')

  
  writeRaster(r_mask,filename=paste0(dir_git,'/globalprep/prs_slr/v2016/int/msla_monthly_coast/msla_monthly_coast_',m_yr,'.tif'),overwrite=T)

}

#apply the clipping function to all files
mclapply(nc_files,months_coast,mc.cores=14)

```

```{r years}

#years of interest

years <- c(2010:2015)

months <- c(1:12)

```

### Explore the data

#### 1. How does mean sea level vary over months?

```{r explore}

#Looking at means and sd over time for each month

files <- list.files(file.path(dir_git,
                              'globalprep/prs_slr/v2016/int/msla_monthly_coast'),full.names=T)

for (i in years){
  
  print(i)
  
  #get all files for the year i
    yr_files <- files[which(substr(files,100,103)==i)]%>%stack()

    names(yr_files) <- months
    #plot & save
    
    png(paste0('figs/monthly_boxplot_',i,'.png'), width = 6, height = 4, units = 'in', res = 300 )
    
    print(bwplot(yr_files,xlab = 'Months',ylab = 'Mean Sea Level Anomaly (meters)'))

    dev.off()
}

img <- png::readPNG('figs/month-boxplots-2011-2014.png')

```

#### 2. What is the distribution of mean and sd mean sea level from January 2010 - December 2015

```{r}

  #get all months for all years 2010-2014
    yr_m_files <- files[which(substr(files,100,103) %in% years)]

  #get unique names for each layer
    layer_names <- unique(basename(yr_m_files) %>% 
                      str_replace('msla_monthly_coast_', '') %>%
                      substr(1, 8)) %>%
                      sort()
  #stack into a raster stack (nlayers = 60) and assign names
    s <- stack(yr_m_files)
    
    names(s) <- layer_names
    
    #calculate the mean
    
    m <- calc(s,fun=mean,na.rm=T)
    
    #calculate the sd
    
    std <- calc(s,fun=function(x){sd(x,na.rm=T)})
    
    #plot + hist
    
    #plot & save
    
    png('figs/mean_sd_msla_2010_2014.png', width = 10, height = 4, units = 'in', res = 300 )
    par(mfrow=c(1,2),
         mai = c(1, 0.5, 1, 1))
    
    plot(m,axes=F,col=cols,box=F,colNA = 'dimgray',main='Mean SLA 2010-2014')
    plot(std,axes=F,col=cols,box=F,colNA = 'dimgray',main = 'Standard Deviation SLA 2010-2015')
    
    dev.off()
    
    h <- stack(m,std)
    names(h)<-c("Mean SL 2010-2015","St. Dev. 2010-2015")
    
    png('figs/mean_sd_msla_hist_2010_2015.png',width = 8, height = 4, units = 'in', res = 300)
    histogram(h)

    dev.off()

```


### Read raw data as monthly means and convert to annual means

Raw data in monthly mean sea level anomalies, at .25 degree grid globally, is processed into annual mean sea level anomalies.  These files are saved in git-annex as GeoTIFFs for later use.

``` {r msla_monthly_to_annual}

all_yrs <- c(1993:2015)

registerDoParallel(14) 

for (j in 1:length(all_yrs)) {
  

  msla_yr <- nc_files[str_detect(nc_files, as.character(all_yrs[j]))]
  
  ### set up an empty list to store rasters for this year
  rast_list_yr <- vector('list', length(msla_yr))
  
  message('Generating annual MSLA raster for ', all_yrs[j])
  
  ### Loop over all files for this year, read raster and assign to list for this year
  for (i in 1:length(msla_yr)) { ### i = 1
    rast_list_yr[i] <- raster(msla_yr[i], nogit = TRUE)
  }
  
  ### stack all rasters for this year, and calc annual mean, then write as raster
  # rast_annual_mean <- brick(rast_list_yr)%>%
  #                     calc(mean,na.rm=T)%>%
  #                     rotate()
  # 
  # rast_file <- file.path(dir_git, 'globalprep/prs_slr/v2016/int/msla_annual_mean', 
  #                        sprintf('rast_msla_annual_%s.tif', all_yrs[j]))
  # 
  ### stack all rasters for this year, and calc annual mean, then write as raster
  rast_annual_sd <- brick(rast_list_yr)%>%
                      calc(sd,na.rm=T)%>%
                      rotate()

  rast_file_sd <- file.path(dir_git, 'globalprep/prs_slr/v2016/int/msla_annual_sd', 
                         sprintf('rast_msla_annual_sd_%s.tif', all_yrs[j]))
  
  #message('Writing raster to ', rast_file)
  # writeRaster(rast_annual_mean,
  #             rast_file,
  #             overwrite = TRUE,
  #             nogit = TRUE)
  
    writeRaster(rast_annual_sd,
              rast_file_sd,
              overwrite = TRUE,
              nogit = TRUE)

}

```




#### 3. How does the data vary in the short and long term

```{r temporal_variance}


#Looking at means and sd over time for each month

sd_files   <- list.files(file.path(dir_git, 'globalprep/prs_slr/v2016/int/msla_annual_sd'),full.names=T)
mean_files <- list.files(file.path(dir_git, 'globalprep/prs_slr/v2016/int/msla_annual_mean'),full.names=T)


for (i in years){
  
  print(i)
  
  #get all files for the year i
    yr_files <- mean_files[which(substr(mean_files,109,112)==i)]%>%raster()
    
    yr_files <- mean_files%>%stack()

    names(yr_files) <- years
    #plot & save
    
    png(paste0('figs/yearly_means_boxplot_',i,'.png'), width = 10, height = 8, units = 'in', res = 300 )
    
    print(bwplot(yr_files,xlab = 'Years',ylab = 'Mean Sea Level Anomaly (meters)'))

    dev.off()
}

```


### Get reference point to rescale each annual raster layer

We want to use the reference period, 1993-2012, since this time period was used to calculate the raw data.

First calculate mean rate of increase in sea level over this period of time per coatsal cell, then get the 99.99th quantile.

```{r ref}

annual_means <- list.files(file.path(dir_git,'globalprep/prs_slr/v2016/int/msla_annual_mean'),pattern = '*.tif',full.names=T)

#stack all annual mean rasters from 1993 - 2012

ref_list <- annual_means[1:20]

#calculate the mean rate of increase per year, reproject, resample, and mask with the ocean raster to make sure we 
# include small pacific islands that we would otherwise lose with boundaries()

# Read in ocean raster with cells at 1km. Use this as a template for resampling

ocean = raster(file.path(dir_M,'git-annex/globalprep/spatial/ocean.tif'))

time <- c(1:20)
ref_mean <- stack(ref_list)%>%
               calc(fun=function(x){ if (is.na(x)){ NA } else {lm(x ~ time)$coefficients[2] }})

projection(ref_mean) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"

#reproject raster to mollweide, resample to 1km, then mask with ocean and grab coastal cels
  ref_1km <- projectRaster(ref_mean,crs = mollCRS,over=T)%>%
                resample(ocean, method = 'ngb')%>%
                mask(ocean,filename = paste0(file.path(
                            dir_anx),'/prs_slr/v2016/int/ref_1km.tif'),overwrite=T)

  bound <- boundaries(ref_1km, type='inner',asNA=T)

  
  ref_1km <- overlay(ref_1km,bound,fun=function(x,y){x*y},filename = paste0(file.path(
                            dir_anx),'/prs_slr/v2016/int/ref_1km_coast.tif'),overwrite=T)
  
  ref_1km[ref_1km==0]<-NA
  
  writeRaster(ref_1km, paste0(file.path(
                            dir_anx),'/prs_slr/v2016/int/ref_1km_coast_out.tif'),overwrite=T)
        
histogram(ref_1km)
ref <- quantile(ref_1km,prob=0.9999,na.rm=T)

#> ref
#     99.99% 
# 0.01729097 

```

The reference point is a rate of change equal to `r ref*100` mm/year.


## Calculate the rate of change over time per cell for each year

```{r}

registerDoParallel(10) 

foreach(i = 1993:2011) %dopar% {
  
  #define the 5 years
   yrs <- c(i,i+1,i+2,i+3,i+4)
   time <- c(1:5) #for the lm

  r <- annual_means[which(substr(annual_means,96,99)%in%yrs)]%>%
        stack()%>%
          calc(fun=function(x){ if (is.na(x)){ NA } else {lm(x ~ time)$coefficients[2] }})
  
  writeRaster(r,filename = paste0(file.path(dir_git),'/globalprep/prs_slr/v2016/int/sla_rate_5yrs/sla_rate_',yrs[1],'-',yrs[5],'.tif'),overwrite=T)

}

s <- list.files(file.path(dir_git,'globalprep/prs_slr/v2016/int/sla_rate_5yrs'),full.names=T)

```


### Rescale each cell according to this reference point.

```{r rescale}

rescale_slr <- function(file){
  
  r <- raster(file)
  
  yr = substr(file,85,93)
  
  out <- calc(r,fun=function(x){ifelse(x>ref,1,x/ref)})
  
  out[out<0]<-0
  
  writeRaster(out,filename = paste0(file.path(dir_git,'globalprep/prs_slr/v2016/int/sla_rate_5yrs_rescale/sla_rate_'),yr,'_rescaled.tif'),overwrite=T)

}

mclapply(s,rescale_slr,mc.cores=14)

```


### Reproject to Mollweide and resample to 1km

```{r reproj_resamp}


registerDoParallel(10) 

#utilize parallelization to rescale & reproject all rasters

slr_reproj <- function(file){

  r_resc<-raster(file)
  
  yrs = substr(file,93,101)
  
  #define projection of the raster before reprojecting
  projection(r_resc) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"

  #reproject raster to mollweide, resample to 1km
  r <- projectRaster(r_resc,crs = mollCRS,over=T)%>%
          resample(ocean, method = 'ngb')%>%
            mask(ref_1km,  #not sure if this is faster than boundaries() or not
                   filename = paste0(file.path(
                      dir_anx),'/prs_slr/v2016/output/slr_moll_1km_rescaled_',yrs,'.tif'),overwrite=T)
}

#list all files
slr_rescale_files <- list.files(file.path(dir_git,'globalprep/prs_slr/v2016/int/sla_rate_5yrs_rescale'),full.names=T)
mclapply(slr_rescale_files,slr_reproj,mc.cores=12)
```

### Plot

```{r plot}

resc <- list.files(file.path(dir_anx,'prs_slr/v2016/output'),full.names = T)%>%stack()

plot(resc,col=cols)

names <-substr(names(resc),23,31)

names(resc)<-names

histogram(resc)


plot(ocean,col='cornsilk2',axes=F,box=F,main='Sea Level Rise Pressure 2010-2014',legend=F)
plot(out[[5]],col=cols,axes=F,box=F,add=T)
```


## Calculate mean pressure by region by year

Using 1000 m region ID raster to run zonal statistics on the pressures layers, calculate the regional average pressures for the study period, and save as a .csv.

``` {r calc_mean_pressures_by_year}

slr_rgn_mean <- zonal(bc_slr_resc, rast_rgn, fun = 'mean') %>%
  as.data.frame() %>%
  rename(pressure = mean, rgn_id = zone) %>%
  left_join(rgn_poly@data %>% select(rgn_id, rgn_name), by = 'rgn_id')

knitr::kable(slr_rgn_mean)

write_csv(slr_rgn_mean, file.path(dir_goal, 'output/slr/slr_rgn_pressures.csv'))

```

    ``` {r child = 'prov/prov_ftr2.Rmd'}
    ```