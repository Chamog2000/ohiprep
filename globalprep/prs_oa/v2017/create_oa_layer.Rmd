---
title: 'OHI 2017: Ocean Acidification Data Prep '
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohiprep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

#Summary

This script takes the raw netCDF data and does the following:

   a. Calculates the annual mean for 2016  
   b. Rescales each annual raster layer from 0 to 1 based on a biological threshold (&#937; <= 1) and the proportional change compared to a historical mean
   c. Interpolates the data to gap-fill for cells where there is no data
   d. Resamples the rescaled raster layer to 1km^2 cell resolution
   e. Mask the resampled data to select only those cells within the ocean
  

#Updates from 2016 assessment

Added one more year of data (2016). Previously interpolation was done using Arcpy. Now Inverse Distance Weigthing interpolation is done in R.

***

#Data Source
**Reference**: [Feely et al.(2009)](https://darchive.mblwhoilibrary.org/bitstream/handle/1912/3180/22-4_feely.pdf?sequence=1&isAllowed=y)

**Downloaded**: March 15, 2016

**Description**:  Aragonite Saturation State  $\Omega_{arg}$

**Native data resolution**: 1 degree cells

**Time range**: 1880-1889 and 2005-2100, monthly data provided for each year. Future years are based on model projections for RCP 8.5. Previous years are hindcast/historical data.

**Format**:  NetCDF

  
**Notes about the data**:  

This data was shared with us by Ivan Lima from Woods Hole Institue for Oceanography in December 2014 and again February 2016. The data came as NetCDFs in an irregular grid format with a resolution of about 1 degree. The data values are monthly average surface &#937; aragonite saturation state.


***

# Methods


##Setup  

The main R libraries needed for this analysis are the `raster`, and `ncdf4` packages.
```{r setup,message=FALSE,warning=FALSE,verbose=FALSE}

#set options for all chunks in code
knitr::opts_chunk$set(warning=FALSE, message=FALSE,fig.width=6, fig.height=6)

#libraries
library(raster)
library(ncdf4)
library(maps)
library(parallel)
library(RColorBrewer)

source("~/github/ohiprep/src/R/common.R")

#define paths for the raw data and OA folder held on git-annex on our NCEAS server, Mazu

raw_dir    = file.path(dir_M, 'git-annex/globalprep/_raw_data')
oagit_dir  = file.path(dir_M, 'git-annex/globalprep/prs_oa')

cols      = rev(colorRampPalette(brewer.pal(9, 'Spectral'))(255)) # rainbow color scheme

```
  
## Load raw data  

We are only adding one year, 2016, so we just need to grab that NetCDF file. The raw data is held on an NCEAS server.

```{r,message=FALSE,warning=FALSE,eval=FALSE}

files <- list.files(file.path(raw_dir,'WHOI/annual'), pattern = "20", recursive=TRUE, full.names = TRUE) #grab only 2016
        
```

## Calculate annual mean aragonite saturation state for 2005 - 2016

The function `annual_arag`, originally defined in the OHI 2015 dataprep files, takes the .nc file for each year, gets the lat, long and arag values for each month and stores them in a data frame. Then using this dataframe, rasterizes the data into a global 1x1 degree grid, reprojects to molleweide and saves the raster to file.

This has already been done for years 2005 - 2015 for the OHI 2016 assessment, but since we are implementing a new interpolation method we are going to rerun all years 2005 - 2016 for OHI 2017 global assessment.

```{r,message=FALSE,warning=FALSE,eval=FALSE}
      
#annual_arag is a function that calculates annual average surface aragonite saturation 

  annual_arag<-function(file){
     
    year = substr(file, nchar(file)-6, nchar(file)-3) #get the year from the file name
    
    #nc_open comes from the ncdf4 package
    # there are 12 files in each .nc file (one for each month of the year)
    nc = nc_open(file)
            
# longitude values are stored in the variable 'TLONG'
      long <- ncvar_get(nc, varid='TLONG')

# latitude values are stored in the variable 'TLAT'
      lat <- ncvar_get(nc, varid='TLAT')
    
  # select the surface aragonite variable (OARG)
      arag<- ncvar_get(nc, varid="OARG")


# land cells are given large, strange value, so set these to NA

      arag[arag==9969209968386869046778552952102584320]<-NA 

      yr_mean = apply(arag, 1:2, mean) # get the annual mean
  
      #create an array with long, lat, aragonite mean data
      A <- array(c(long,lat, yr_mean), dim=c(320,384,3))
      B <- apply(A, 3, cbind)
  
      #lon=x, lat=y
      x = B[,1]
      y = B[,2]
  
      C = as.data.frame(B)
      names(C)<-c('x', 'y', 'value')
  
      #set extent to lon/lat
      e <- extent(C[,1:2])
      r <- raster(e, ncol=320, nrow=384) #create empty raster with e extent
  
      #rasterize the dataframe
      out <- rasterize(C[,1:2], r, C[,3], fun=function(x,...)mean(x), progress='text') # i had to create a mean function here for "multiple points in a cell"
      extent(out)<-c(0, 360, -80, 90) #data extent is 0,360,-80, 90 (the -80 is not a typo)
      out <- rotate(out) #shifts data from 0-360 to -180-180
  
  
      plot(out)
  #    map('world',col='gray95',fill=T,border='gray80',add=T)
  
      #notice the empty cells, due to irregular grid, so plot using a different projection
  
      # Define initial projection for out
      projection(out) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"
  
      # define mollweide projection
      mollCRS <- CRS('+proj=moll')

      # then convert to mollweide and other projections
      out_moll <- projectRaster(out, crs=mollCRS, over=TRUE)
  
      # plot results
     plot(out_moll)
      
     print(cellStats(out_moll, stat='mean', na.rm=TRUE))
     
  writeRaster(out_moll,filename = paste0(file.path(oagit_dir, "v2017/int/annual_avg_moll/global_arag_avg_moll_"), year), format='GTiff', overwrite=T)
    
}

#run the function for each file in the file list using lapply

  mclapply(files,annual_arag,mc.cores = 16) #run parallel
```

```{r plot mean 2016 raster}

#Here is the output for 2016

r_2016 <- raster(file.path(oagit_dir,'v2017/int/annual_avg_moll/global_arag_avg_moll_2016.tif'))

plot(r_2016,box=F,axes=F,main="Mean Ωaragonite saturation state 2016", col=cols)
 
```


## Rescale from 0 to 1

This pressure layer is rescaled so that all values lie between 0 and 1 using both a historical reference period and a biological reference point. All cells with values less than one, indicating an undersaturated state, are set equal to the highest stressor level, 1. For all other cells, rescaling the aragonite staturation state value to between 0 and 1 relies upon the change in saturation relative to the reference period.


### Historical Mean

The historical mean &#937 aragonite saturation state from 1880 - 1889 was calculated for OHI 2015. The same raster was used for OHI 2016 and is again used here for comparison.

```{r histMean}
hist <- raster(file.path(dir_M,'git-annex/globalprep/prs_oa/v2015/working/global_oa_1880_1889_arag_mean_moll.tif'))

plot(hist,main='Mean Ωaragonite 1880-1889', col=cols, box=F,axes=F)
```


Deviation from aragonite saturation state is determined for each year in the study period using this equation:

$$\Delta \Omega_{year} = \frac{(\Omega_{base} - \Omega_{year})}{(\Omega_{base} - 1)}$$

Note that the current value is subtracted from the baseline; this way, a reduction in $\Omega$ becomes a positive pressure value.  It is then normalized by the current mean state; so a decrease in $\Omega$ while the current state is high indicates less pressure than the same decrease when the current state is near 1. 

$\Delta \Omega_{year}$ is then modified to account for increases in aragonite saturation state (pressure = 0) and arag sat state less than 1 (pressure = 1).

The `oaRescale` function rescales each of the annual rasters. If the current value is less than or equal to 1, it is set to 1, otherwise the value is calculated from the above equation.

```{r rescale,eval=F}

#for each layer, all values <=1 are assigned a 1, otherwise old-new/(old-1)

oaRescale <- function(file){
  
  yr   = substr(file, nchar(file)-7, nchar(file)-4)  #get year of file
  mean = raster(file)                              #get seasonal mean aragonite raster for given year
  diff = (hist-mean)/(hist-1)
  mean[mean<=1] <- 1                                 #all values at or less than 1 are given a value of 1
  mean[mean>1] <- diff[mean>1]                     #all cells with values greater than 1 are swapped out with their amount of change scaled to how close to 1 
  mean[mean<0] <- 0                                  #all values less than 0 (indicating a decrease in acidity) are capped at 0

    writeRaster(mean, filename=paste0(oagit_dir, '/v2017/int/annual_avg_moll_rescaled/oa_rescaled_', yr, sep=""), format='GTiff', overwrite=TRUE)
}

files = list.files(file.path(oagit_dir, 'v2017/int/annual_avg_moll'), full.names=TRUE)

mclapply(files, oaRescale, mc.cores = 16)
```

```{r plot rescale}
r <- raster(file.path(oagit_dir, 'v2017/int/oa_rescaled_2016.tif'))
plot(r, col=cols, box=FALSE, axes=FALSE, main = 'Rescaled Ωaragonite layer for 2016')
```


## Interpolate

Since there are oceanic cells with no information in the raw data, we need to fill in these gaps. We do this by interpolating across the globe using the data we have with an Inverse Distance Weighting (IDW) function. Previously this was done using `arcpy` from ArcGIS.


```{r interpolate}

library(gstat)

files <- list.files(file.path(oagit_dir,'v2017/int/annual_avg_moll_rescaled'), full.names=TRUE)

int_function <- function(file){
r  <- raster(file) #oa raster
yr <- substr(file, nchar(file)-7, nchar(file)-4)
xy <- data.frame(xyFromCell(r, 1:ncell(r)))                         #get xy coords into dataframe
v  <- getValues(r)                                                  #get cell values 
tmpdf <- cbind(xy, v)%>%filter(!is.na(v))                           #create dataframe of x,y, and values. remove NAs (throws error since these are cells we are interpolating over)
mg <- gstat(id = "v", formula = v~1, locations = ~x+y, data=tmpdf,
            nmax=7, set=list(idp = 2)) #define model. power function = 2, this is default for idw models
z <- interpolate(r, mg, progress='text')                            #interpolate across NA cells
writeRaster(z,filename  = paste0(file.path(oagit_dir), "/v2017/int/annual_avg_moll_rescaled_int/oa_resc_int_", yr, ".tif"))
}

mclapply(files, int_function,mc.cores=16)

plot(raster(file.path(oagit_dir,'v2017/int/annual_avg_moll_rescaled_int/oa_resc_int_2016.tif')), col=cols, box=FALSE, axes=FALSE, main='Rescaled and Interpolated Ωaragonite layer for 2016')

```


## Resample & Land Mask

All pressure layers need to be resampled to 1km^2^ cell resolution. We have a template ocean raster with cells at this resolution that we use to resample all pressure layers. You won't see any difference between the plot above and this one since we are using the nearest neighbor method when resampling which maintains the original cell value for each of resampled cell.

```{r resample,eval=F}

files <- list.files(file.path(oagit_dir,'v2017/int/annual_avg_moll_rescaled_int'),full.names=T)

oaResample <- function(file){
  
  yr <- substr(file,nchar(file)-7,nchar(file)-4)
  
  raster(file)%>%
  resample(ocean,method = 'ngb')%>%
  mask(ocean,filename = paste0(oagit_dir,'/v2017/output/oa_prs_layer_',yr,'.tif',overwrite=T)
  
}

mclapply(files,oaResample,mc.cores = 16)
```


# Final Pressure Layer

```{r plot_final}
plot(raster(file.path(oagit_dir,'v2017/output/oa_prs_layer_2016.tif')),box=F,axes=F,col=cols,main='Final Ocean Acidification \nPressure Layer 2016')

```

# Gap-filled cells

We want to create a raster layer that shows all cells that were gap-filled. Since they were the same cells interpolated across all years, we only need to create one raster.

```{r,eval=F}

    #Rescaled data before interpolation 
      pre_int = resample(r,ocean,progress='text')

    #after interpolation,
      r_int = raster(file.path(oagit_dir,'v2017/output/oa_prs_layer_2016.tif'))
    
    #interpolated (or gap-filled) cells    
    interp_cells = mask(r_int,pre_int,inverse=TRUE,filename = file.path(oagit_dir,'v2017/output/oa_interpolated_cells.tif'))
```

```{r plot_interp_cells}

    plot(raster(file.path(oagit_dir,'v2017/output/oa_interpolated_cells.tif')),
         col=cols,box=F,axes=F,main='Interpolated cells')

```


#Citation information  

Woods Hole Oceanographic Institution. 2014 update to data originally published in: Feely, R.A., S.C. Doney, and
S.R. Cooley. 2009. Ocean acidification: Present conditions and future changes in a high-CO2 world.
Oceanography 22(4):36–47

